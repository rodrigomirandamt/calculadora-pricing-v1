ğŸ“Œ Pricing de EmprÃ©stimos Consignados â€“ Guia Detalhado

1. Objetivo Geral
-----------------
Determinar a parcela mensal ajustada ao risco (PMT_risco) de emprÃ©stimos consignados privados,
levando em consideraÃ§Ã£o riscos de fechamento da empresa empregadora e rotatividade (demissÃ£o do tomador).

Dado:
- PV: valor presente do emprÃ©stimo
- n: nÃºmero total de parcelas mensais
- p_close_ann: probabilidade anual de fechamento
- p_rot_m: probabilidade mensal de rotatividade do setor
- d: tempo de atraso esperado apÃ³s rotatividade (em meses)

O cÃ³digo gera mÃ©tricas adicionais para anÃ¡lise detalhada de risco e precificaÃ§Ã£o.

2. Estrutura do Projeto
-----------------------
A calculadora estÃ¡ organizada em uma estrutura modular:

    calculadora-pricing-v1/
    â”œâ”€â”€ main.py                # Script principal (ponto de entrada)
    â”œâ”€â”€ resultados/            # DiretÃ³rio onde os resultados sÃ£o salvos
    â”‚   â”œâ”€â”€ resultado_*.csv    # Arquivos CSV com resultados dos cÃ¡lculos
    â”‚   â””â”€â”€ resultado_*.txt    # RelatÃ³rios de processamento
    â””â”€â”€ src/                   # Pacote com os mÃ³dulos da aplicaÃ§Ã£o
        â”œâ”€â”€ __init__.py        # Torna src um pacote importÃ¡vel
        â”œâ”€â”€ config.py          # ConfiguraÃ§Ãµes e constantes
        â”œâ”€â”€ data_utils.py      # FunÃ§Ãµes para carregamento e processamento de dados
        â”œâ”€â”€ pricing_model.py   # LÃ³gica do modelo matemÃ¡tico
        â””â”€â”€ validacao.py       # FunÃ§Ãµes para validaÃ§Ã£o dos resultados

FunÃ§Ãµes dos mÃ³dulos:

* **config.py**: MantÃ©m parÃ¢metros financeiros (CDI, funding, custos), parÃ¢metros de risco (LGD, informalidade), e caminhos para arquivos.
* **data_utils.py**: Carregamento e processamento de dados de entrada, extraÃ§Ã£o de taxas de rotatividade e risco.
* **pricing_model.py**: ImplementaÃ§Ã£o da lÃ³gica matemÃ¡tica para cÃ¡lculo do PMT ajustado ao risco.
* **validacao.py**: ValidaÃ§Ã£o de resultados e checagem de inconsistÃªncias.

3. Estrutura LÃ³gica do Algoritmo
--------------------------------
Etapas principais do fluxo:

1. Carregamento dos dados de entrada
   - Dados histÃ³ricos de risco por CNAE e porte da empresa.
   - Base de contratos para precificaÃ§Ã£o.

2. ConversÃ£o de probabilidades anuais em hazards mensais:
   h_close = 1 - (1 - p_close_ann)^(1/12)
   h_turnover = h_close + (1 - h_close) * (p_rot_m * 0.66)
   h_default = h_turnover * 10%
   h_delay = h_turnover * 90%

3. Curva de sobrevivÃªncia e densidades
   S[0] = 1
   S[u] = S[u-1] * (1 - h_default - h_delay)
   f_default[u] = S[u-1] * h_default
   f_delay[u] = S[u-1] * h_delay

4. PMT livre de risco (PMT_base):
   PMT_base = PV * r_tar_m / (1 - (1 + r_tar_m)^(-n))
   r_tar_m = (1 + R_base)^(1/12) - 1

5. CÃ¡lculo de PMT ajustado ao risco (PMT_risco)
-----------------------------------------------

Queremos encontrar o valor da parcela mensal PMT_risco tal que o valor presente esperado dos fluxos futuros (EPV_total) iguale o valor do emprÃ©stimo:

    EPV_total = EPV_surv + EPV_delay + EPV_default = PV

Onde cada componente Ã© calculado da seguinte forma:

5.1. EPV da sobrevivÃªncia atÃ© o fim (sem evento):

    EPV_surv = S[n] * sum_{t=1}^{n} [ PMT / (1 + r)^t ]

    Onde:
      - S[n] Ã© a probabilidade de chegar atÃ© a Ãºltima parcela sem nenhum evento
      - r = r_tar_m Ã© a taxa-meta mensal

5.2. EPV em caso de atraso (evento ocorre no mÃªs u <= n):

    EPV_delay = sum_{u=1}^{n} f_delay[u] * [
                   sum_{t=1}^{u-1} [ PMT / (1 + r)^t ] +
                   sum_{t=u}^{n}   [ PMT / (1 + r)^{t + d} ]
                ]

    Onde:
      - d Ã© o nÃºmero de meses de atraso apÃ³s o evento de desligamento

5.3. EPV em caso de default (evento ocorre no mÃªs u <= n):

    EPV_default = sum_{u=1}^{n} f_default[u] * [
                      sum_{t=1}^{u-1} [ PMT / (1 + r)^t ] +
                      (1 - LGD) * B[u-1] / (1 + r)^u
                  ]

    Onde:
      - LGD Ã© a perda dada o default (ex: 80%)
      - B[u-1] Ã© o saldo devedor imediatamente antes do default

5.4. ResoluÃ§Ã£o numÃ©rica:

A equaÃ§Ã£o:

    EPV_surv + EPV_delay + EPV_default = PV

Ã© resolvida numericamente com fsolve, ajustando PMT atÃ© que a igualdade se satisfaÃ§a.

6. Spreads e TIR do cliente:
   spread_valor = PMT_risco - PMT_base
   r_min_m = root of sum(PMT_risco / (1 + r)^t) = PV
   spread = r_min_m - r_tar_m
   spread_anual = R_min_anual - R_base

7. KPIs adicionais:
   Expected_payments = sum S[0..n-1]
   Mean_time_to_event = sum u * (f_def[u] + f_del[u])
   E_Duration = sum u*f_def[u] + sum (n+d)*f_del[u] + n*S[n]
   LGD_ponderado = sum f_def[u] * LGD * saldo[u-1] / PV

4. ExecuÃ§Ã£o e Uso
-----------------
Para executar a calculadora:

```
python main.py [opÃ§Ãµes]
```

OpÃ§Ãµes disponÃ­veis:
- `-n, --num`: NÃºmero de linhas a processar
- `--sample`: Tamanho da amostra aleatÃ³ria a extrair
- `-o, --output`: Caminho para o arquivo de saÃ­da
- `--base-path`: Caminho do arquivo da base de contratos
- `--rot-path`: Caminho do arquivo de rotatividade
- `--risk-path`: Caminho do arquivo de riscos de fechamento

Os resultados incluem:
1. Arquivo CSV na pasta `resultados/` com data no nome
2. RelatÃ³rio TXT com informaÃ§Ãµes sobre:
   - VersÃ£o da calculadora
   - Arquivos utilizados
   - HipÃ³teses de cÃ¡lculo
   - Resultados da validaÃ§Ã£o

5. Colunas Exportadas no CSV
----------------------------
â€¢ personid, contractid, cnae_section, porte
â€¢ PV, n
â€¢ CDI_anual, Funding, Custo_Operacional, Margem, R_base_anual
â€¢ h_close, h_turnover, h_default, h_delay
â€¢ S_n, P_default_total, P_delay_total
â€¢ EPV_surv, EPV_delay, EPV_default
â€¢ Expected_payments, Mean_time_to_event, E_Duration, LGD_ponderado
â€¢ PMT_base, PMT_risco, spread_valor
â€¢ r_tar_m, r_min_m, spread, R_min_anual, spread_anual
â€¢ calc_time_s

6. Finalidade prÃ¡tica
---------------------
â€¢ Avaliar se o preÃ§o do crÃ©dito cobre o risco efetivamente incorrido.
â€¢ Calibrar polÃ­ticas internas de precificaÃ§Ã£o e riscos.
â€¢ Permitir anÃ¡lises sensÃ­veis ao risco por setor, porte e idade da empresa.
â€¢ Dimensionar estratÃ©gias comerciais e de cobranÃ§a com base em cenÃ¡rios esperados.

ğŸ“– ProvÃ©rbios 21:5 (NVI) â€” "Os planos bem elaborados levam Ã  fartura."
